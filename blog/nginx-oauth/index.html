<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Implementing Discord OAuth in NGINX | Abed&#39;s Tech Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Implementing Discord OAuth2 NGINX using the NJS module
I recently began offloading the authentication and authorization portion of my self-hosted applications to third party services by way of OAuth. This post is about how I implemented the OAuth2 token issuance logic in an application-agnostic manner, fully in NGINX.
If you are not familiar with OAuth, I will demonstrate it below with an example scenario.
Client wishes to authorize their discord credentials to log into example.">
<meta name="author" content="">
<link rel="canonical" href="https://abedef.ca/blog/nginx-oauth/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css" integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://abedef.ca/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://abedef.ca/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://abedef.ca/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://abedef.ca/apple-touch-icon.png">
<link rel="mask-icon" href="https://abedef.ca/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Implementing Discord OAuth in NGINX" />
<meta property="og:description" content="Implementing Discord OAuth2 NGINX using the NJS module
I recently began offloading the authentication and authorization portion of my self-hosted applications to third party services by way of OAuth. This post is about how I implemented the OAuth2 token issuance logic in an application-agnostic manner, fully in NGINX.
If you are not familiar with OAuth, I will demonstrate it below with an example scenario.
Client wishes to authorize their discord credentials to log into example." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://abedef.ca/blog/nginx-oauth/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-11-18T15:38:51-05:00" />
<meta property="article:modified_time" content="2022-11-18T15:38:51-05:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Implementing Discord OAuth in NGINX"/>
<meta name="twitter:description" content="Implementing Discord OAuth2 NGINX using the NJS module
I recently began offloading the authentication and authorization portion of my self-hosted applications to third party services by way of OAuth. This post is about how I implemented the OAuth2 token issuance logic in an application-agnostic manner, fully in NGINX.
If you are not familiar with OAuth, I will demonstrate it below with an example scenario.
Client wishes to authorize their discord credentials to log into example."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://abedef.ca/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Implementing Discord OAuth in NGINX",
      "item": "https://abedef.ca/blog/nginx-oauth/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Implementing Discord OAuth in NGINX",
  "name": "Implementing Discord OAuth in NGINX",
  "description": "Implementing Discord OAuth2 NGINX using the NJS module\nI recently began offloading the authentication and authorization portion of my self-hosted applications to third party services by way of OAuth. This post is about how I implemented the OAuth2 token issuance logic in an application-agnostic manner, fully in NGINX.\nIf you are not familiar with OAuth, I will demonstrate it below with an example scenario.\nClient wishes to authorize their discord credentials to log into example.",
  "keywords": [
    
  ],
  "articleBody": "Implementing Discord OAuth2 NGINX using the NJS module\nI recently began offloading the authentication and authorization portion of my self-hosted applications to third party services by way of OAuth. This post is about how I implemented the OAuth2 token issuance logic in an application-agnostic manner, fully in NGINX.\nIf you are not familiar with OAuth, I will demonstrate it below with an example scenario.\nClient wishes to authorize their discord credentials to log into example.com Usually, the client will click on some login link which will initiate roughly the following flow:\nClient navigates to a third party provider login page with required parameters In the case of discord, this contained: client_id redirect_uri (must be registered for your discord application in the developer portal) response_type scope discord provided a tool to generate this URL Client successfully logs in to the third party login page and clicks “Authorize” Client is redirected to example.com (according to the preset redirect URL) with a code provided as a query parameter Server retrieves token from the token endpoint using a number of parameters along with the code from the previous step, returns it to the client This is trivial enough to implement in the application layer, but I wanted to avoid this repetition of code between my projects.\nI set out to implement this flow in NGINX. To do this, I need to accomplish a number of things:\nAn endpoint that will retrieve the code returned to the client by the discord login page An endpoint that will subsequently be used to retrieve the token using the code from the previous step and the tricky part is here – the response we are looking for (the access token) is returned as JSON in the response body of (2) we need to parse the response body and save the values we are looking for in a future subrequest, set the appropriate response headers so the client saves the tokens as session cookies – making them available to my web applications served from behind nginx After much trial and error, I came upon a method that works for me. Issues I ran into along the way included “tried to make http response from https endpoint” or some shit and another annoying one that was incoherent – the body was just gibberish. Straight up gibberish. Sometimes I would include the gunzip on directive and it would change the gibberish, but it was still gibberish. I still have not figured out exactly what did it in the end, but I realized I could not examine the body in certain situations, and also I needed to set the “Accept-Encoding” to “” in order to prevent the discord API from returning anything compressed. Some combination of those things did the trick, and that’s good enough for me. I’ll include all my config somewhere.\nThe parts of interest:\nThe logic in Javascript implemented in the application layer\u2028console.log(Found token ${TOKEN});\n// If there is a code provided, try to authenticate with it const code = url.searchParams.get('code'); if (code) { console.log(`authorizing with code ${code}`); let body = new URLSearchParams(); body.set('client_id', '1042267625692082236') body.set('client_secret', 'GcN5QiApgxLpwzIp452HWbJ1XdOQlVru') body.set('grant_type', 'authorization_code') body.set('code', code) body.set('redirect_uri', 'https://genieindex.ca/') const res = await fetch(\"https://discord.com/api/v10/oauth2/token\", { method: \"POST\", headers: { \"Content-Type\": \"application/x-www-form-urlencoded\", }, body: body, }); let data = await res.json(); console.log(data); if (data.access_token \u0026\u0026 data.refresh_token) { cookies.set('discord_access_token', data.access_token); cookies.set('discord_refresh_token', data.refresh_token); } throw redirect(302, '/'); } console.log(\"Retrieving saved token values\"); console.log(cookies.get('discord_access_token')); console.log(cookies.get('discord_refresh_token')); Useful links:\nhttps://www.nginx.com/blog/validating-oauth-2-0-access-tokens-nginx/ https://nginx.org/en/docs/http/ngx_http_js_module.html TODO:\nUse auth_request to on page endpoints to validate the provided token https://nginx.org/en/docs/http/ngx_http_auth_request_module.html Implement token refreshing See below link for oauth2 refreshing https://discord.com/developers/docs/topics/oauth2#authorization-code-grant-refresh-token-exchange-example ",
  "wordCount" : "594",
  "inLanguage": "en",
  "datePublished": "2022-11-18T15:38:51-05:00",
  "dateModified": "2022-11-18T15:38:51-05:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://abedef.ca/blog/nginx-oauth/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Abed's Tech Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://abedef.ca/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://abedef.ca/" accesskey="h" title="Abed&#39;s Tech Blog (Alt + H)">Abed&#39;s Tech Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Implementing Discord OAuth in NGINX
    </h1>
    <div class="post-meta"><span title='2022-11-18 15:38:51 -0500 EST'>November 18, 2022</span>

</div>
  </header> 
  <div class="post-content"><p>Implementing Discord OAuth2 NGINX using the NJS module</p>
<p>I recently began offloading the authentication and authorization portion of my self-hosted applications to third party services by way of OAuth. This post is about how I implemented the OAuth2 token issuance logic in an application-agnostic manner, fully in NGINX.</p>
<p>If you are not familiar with OAuth, I will demonstrate it below with an example scenario.</p>
<p>Client wishes to authorize their discord credentials to log into example.com
 Usually, the client will click on some login link which will initiate roughly the following flow:</p>
<ol>
<li>Client navigates to a third party provider login page with required parameters
<ul>
<li>In the case of discord, this contained:
<ul>
<li>client_id</li>
<li>redirect_uri (must be registered for your discord application in the developer portal)</li>
<li>response_type</li>
<li>scope</li>
</ul>
</li>
<li>discord provided a tool to generate this URL</li>
</ul>
</li>
<li>Client successfully logs in to the third party login page and clicks “Authorize”</li>
<li>Client is redirected to example.com (according to the preset redirect URL) with a code provided as a query parameter</li>
<li>Server retrieves token from the token endpoint using a number of parameters along with the code from the previous step, returns it to the client</li>
</ol>
<p>This is trivial enough to implement in the application layer, but I wanted to avoid this repetition of code between my projects.</p>
<p>I set out to implement this flow in NGINX. To do this, I need to accomplish a number of things:</p>
<ol>
<li>An endpoint that will retrieve the code returned to the client by the discord login page</li>
<li>An endpoint that will subsequently be used to retrieve the token using the code from the previous step</li>
<li>and the tricky part is here – the response we are looking for (the access token) is returned as JSON in the response body of (2)
<ul>
<li>we need to parse the response body and save the values we are looking for</li>
</ul>
</li>
<li>in a future subrequest, set the appropriate response headers so the client saves the tokens as session cookies – making them available to my web applications served from behind nginx</li>
</ol>
<p>After much trial and error, I came upon a method that works for me.
 Issues I ran into along the way included “tried to make http response from https endpoint” or some shit and another annoying one that was incoherent – the body was just gibberish. Straight up gibberish. Sometimes I would include the <code>gunzip on</code> directive and it would change the gibberish, but it was still gibberish. I still have not figured out exactly what did it in the end, but I realized I could not examine the body in certain situations, and also I needed to set the “Accept-Encoding” to “” in order to prevent the discord API from returning anything compressed. Some combination of those things did the trick, and that’s good enough for me. I’ll include all my config somewhere.</p>
<p>The parts of interest:</p>
<p>The logic in Javascript implemented in the application layer 
console.log(<code>Found token ${TOKEN}</code>);</p>
<pre><code>// If there is a code provided, try to authenticate with it
const code = url.searchParams.get('code');

if (code) {
    console.log(`authorizing with code ${code}`);

    let body = new URLSearchParams();
    body.set('client_id', '1042267625692082236')
    body.set('client_secret', 'GcN5QiApgxLpwzIp452HWbJ1XdOQlVru')
    body.set('grant_type', 'authorization_code')
    body.set('code', code)
    body.set('redirect_uri', 'https://genieindex.ca/')
    const res = await fetch(&quot;https://discord.com/api/v10/oauth2/token&quot;, {
        method: &quot;POST&quot;,
        headers: {
            &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,
        },
        body: body,
    });
    let data = await res.json();

    console.log(data);

    if (data.access_token &amp;&amp; data.refresh_token) {
        cookies.set('discord_access_token', data.access_token);
        cookies.set('discord_refresh_token', data.refresh_token);
    }

    throw redirect(302, '/');
}

console.log(&quot;Retrieving saved token values&quot;);
console.log(cookies.get('discord_access_token'));
console.log(cookies.get('discord_refresh_token'));
</code></pre>
<p>Useful links:</p>
<ul>
<li><a href="https://www.nginx.com/blog/validating-oauth-2-0-access-tokens-nginx/">https://www.nginx.com/blog/validating-oauth-2-0-access-tokens-nginx/</a></li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_js_module.html">https://nginx.org/en/docs/http/ngx_http_js_module.html</a></li>
</ul>
<p>TODO:</p>
<ul>
<li>Use auth_request to on page endpoints to validate the provided token
<ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_auth_request_module.html">https://nginx.org/en/docs/http/ngx_http_auth_request_module.html</a></li>
</ul>
</li>
<li>Implement token refreshing
<ul>
<li>See below link for oauth2 refreshing</li>
<li><a href="https://discord.com/developers/docs/topics/oauth2#authorization-code-grant-refresh-token-exchange-example">https://discord.com/developers/docs/topics/oauth2#authorization-code-grant-refresh-token-exchange-example</a></li>
</ul>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://abedef.ca/">Abed&#39;s Tech Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
